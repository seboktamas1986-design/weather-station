<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DS18B20 Hőmérséklet</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
  #lastTemp { font-size: 2em; margin-bottom: 10px; }
  #lastTime { font-size: 1.2em; margin-bottom: 20px; color: #555; }
  canvas { max-width: 100%; }
  #minmax { margin-top: 15px; font-size: 1.2em; }
  .sub { font-size: 0.8em; color: #555; }
</style>
</head>
<body>

<h1>Kültéri időjárás állomás</h1>
<div id="lastTemp">Betöltés...</div>
<div id="lastTime"></div>
<canvas id="tempChart"></canvas>
<div id="minmax"></div>

<script>
const apiKey = 'XG3F9TP24AF5QF8A'; // Thingspeak API kulcs
const channelId = '3053905'; // Thingspeak csatorna azonosítója
const updateInterval = 15000; // 15 mp-ként adatfrissítés

let chart;
let timeLabels = [];
let tempData = [];

// Funkció a Thingspeak adatok lekérésére
async function fetchData() {
    try {
        // 288 adat kb. 24 órányi, ha 5 percenként mérsz
        const response = await fetch(`https://api.thingspeak.com/channels/${channelId}/fields/1.json?api_key=${apiKey}&results=288`);
        const data = await response.json();
        const feeds = data.feeds.filter(f => f.field1 !== null);

        // Utolsó mérés adatainak lekérése
        const lastTemp = Number(feeds[feeds.length - 1].field1).toFixed(2);
        const lastTime = new Date(feeds[feeds.length - 1].created_at).toLocaleString();

        document.getElementById('lastTemp').innerText = `Aktuális hőmérséklet: ${lastTemp} °C`;
        document.getElementById('lastTime').innerText = `Utolsó mérés időpontja: ${lastTime}`;

        // Adatok a grafikonhoz
        timeLabels = feeds.map(f => new Date(f.created_at).toLocaleTimeString());
        tempData = feeds.map(f => parseFloat(f.field1));

        updateChart();

        // Min / Max számítás
        const minVal = Math.min(...tempData);
        const maxVal = Math.max(...tempData);

        const minIndex = tempData.indexOf(minVal);
        const maxIndex = tempData.indexOf(maxVal);

        const minTime = new Date(feeds[minIndex].created_at).toLocaleString();
        const maxTime = new Date(feeds[maxIndex].created_at).toLocaleString();

        document.getElementById('minmax').innerHTML = 
            `Elmúlt 24 óra minimuma: ${minVal.toFixed(2)} °C <span class="sub">(${minTime})</span><br>
             Elmúlt 24 óra maximum: ${maxVal.toFixed(2)} °C <span class="sub">(${maxTime})</span>`;
        
    } catch (err) {
        console.error(err);
        document.getElementById('lastTemp').innerText = 'Hiba az adatok lekérésekor';
        document.getElementById('lastTime').innerText = '';
        document.getElementById('minmax').innerText = '';
    }
}

// Grafikon inicializálása / frissítése
function updateChart() {
    if (!chart) {
        const ctx = document.getElementById('tempChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Hőmérséklet (°C)',
                    data: tempData,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { display: true },
                    y: { display: true, beginAtZero: false }
                }
            }
        });
    } else {
        chart.data.labels = timeLabels;
        chart.data.datasets[0].data = tempData;
        chart.update();
    }
}

// Első adatlekérés és frissítés interval
fetchData();
setInterval(fetchData, updateInterval);
</script>

</body>
</html>
